/* ---------- GOOGLE DRIVE ---------- */
const CLIENT_ID = '688330997573-6mc9ohu23utu12emn6hgiegf884jfgp9.apps.googleusercontent.com';
const API_KEY   = 'AIzaSyDQ5e0WCYFrk5dGjlFKzyX71pGYrhOXdCE';
const SCOPES    = 'https://www.googleapis.com/auth/drive.file';
let gToken      = localStorage.getItem('gdrive_token');

/* ---------- AUTENTICACIÓN GOOGLE ---------- */
if (!gToken) {
  const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${location.origin}&scope=${SCOPES}&response_type=token&include_granted_scopes=true`;
  window.open(authUrl, 'auth', 'width=500,height=600');
  window.addEventListener('load', () => {
    const hash = location.hash;
    if (hash.includes('access_token')) {
      const token = hash.match(/access_token=([^&]+)/)[1];
      localStorage.setItem('gdrive_token', token);
      gToken = token;
      location.hash = '';
    }
  });
}

/* ---------- SUBIR COPIA A GOOGLE DRIVE ---------- */
async function subirCopiaADrive(registro) {
  if (!gToken) return;
  const csv = [
    Object.keys(registro).join(','),
    Object.values(registro).map(v => `"${v}"`).join(',')
  ].join('\n');
  const blob      = new Blob([csv], { type: 'text/csv' });
  const metadata  = {
    name: `recogida_${registro.numero_entrada}_${registro.fecha}.csv`,
    mimeType: 'text/csv',
    parents: ['root']
  };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
  form.append('file', blob);

  const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + gToken },
    body: form
  });
  if (resp.ok) console.log('Copia subida a Drive ✅');
  else console.warn('Error al subir a Drive', await resp.text());
}

/* ---------- FUNCIONES AUXILIARES ---------- */
let map;
let marker;

function generarNumeroEntrada() {
  const hoy = new Date();
  const yyyy = hoy.getFullYear();
  const mm = String(hoy.getMonth() + 1).padStart(2, '0');
  const dd = String(hoy.getDate()).padStart(2, '0');
  const clave = `numero_entrada_${yyyy}_${mm}`;
  const max = parseInt(localStorage.getItem(clave) || '0') + 1;
  localStorage.setItem(clave, max);
  return `${yyyy}-${mm}-${dd}-${String(max).padStart(3, '0')}`;
}

function cargarEspecies() {
  fetch('especies.json')
    .then(res => res.json())
    .then(data => {
      const comunList = document.getElementById('especies-comun-list');
      const cientificoList = document.getElementById('especies-cientifico-list');
      data.especies.forEach(e => {
        const option1 = document.createElement('option');
        option1.value = e.comun;
        const option2 = document.createElement('option');
        option2.value = e.cientifico;
        comunList.appendChild(option1);
        cientificoList.appendChild(option2);
      });
    });
}

function cargarMunicipios() {
  fetch('municipios.json')
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('municipios-list');
      data.municipios.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        list.appendChild(option);
      });
    });
}

function iniciarMapa() {
  map = L.map('map').setView([38.5, -0.5], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);
    document.getElementById('coordenadas_mapa').value = `${lat}, ${lng}`;
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
  });
}

/* ---------- BOTÓN CERRAR APP ---------- */
document.getElementById('btnCerrar').addEventListener('click', () => {
  if (confirm('¿Cerrar la aplicación?')) window.close();
});

/* ---------- GEOLOCALIZAR ---------- */
document.getElementById('btnLocalizar').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    document.getElementById('coordenadas').value = `${lat}, ${lng}`;
  }, () => alert('No se pudo obtener la ubicación.'));
});

/* ---------- BORRAR COORDENADAS ---------- */
document.getElementById('btnBorrarCoords').addEventListener('click', () => {
  document.getElementById('coordenadas_mapa').value = '';
  if (marker) map.removeLayer(marker);
});

/* ---------- BOTÓN VER COPIAS ---------- */
document.getElementById('btnVerCopias').addEventListener('click', () => {
  const copias = JSON.parse(localStorage.getItem('copiasRecogidas') || '[]');
  if (!copias.length) { alert('No hay copias guardadas'); return; }
  let texto = 'COPIAS GUARDADAS:\n\n';
  copias.forEach((c, i) => {
    texto += `--- Copia ${i + 1} ---\n`;
    texto += `Nº entrada: ${c.numero_entrada}\n`;
    texto += `Común: ${c.especie_comun}\n`;
    texto += `Científico: ${c.especie_cientifico}\n`;
    texto += `Fecha: ${c.fecha}\n`;
    texto += `Municipio: ${c.municipio}\n`;
    texto += `Timestamp: ${c.timestamp}\n\n`;
  });
  alert(texto);
});

/* ---------- ENVÍO DEL FORMULARIO ---------- */
document.getElementById('formulario').addEventListener('submit', async function(e) {
  e.preventDefault();

  const btnEnviar = document.getElementById('enviarBtn');
  const btnVerCopias = document.getElementById('btnVerCopias');
  btnEnviar.disabled = true;
  btnVerCopias.disabled = true;
  setTimeout(() => {
    btnEnviar.disabled = false;
    btnVerCopias.disabled = false;
  }, 1000);

  const data = Object.fromEntries(new FormData(e.target).entries());

  // Procesar checkboxes
  data.posible_causa = Array.from(document.querySelectorAll('input[name="posible_causa"]:checked')).map(el => el.value).join('; ');
  data.remitente = Array.from(document.querySelectorAll('input[name="remitente"]:checked')).map(el => el.value).join('; ');
  data.estado_animal = Array.from(document.querySelectorAll('input[name="estado_animal"]:checked')).map(el => el.value).join('; ');

  if (!data.numero_entrada) data.numero_entrada = generarNumeroEntrada();

  // Guardar copia local
  const copia = { ...data, timestamp: new Date().toISOString() };
  let copias = JSON.parse(localStorage.getItem('copiasRecogidas') || '[]');
  copias.push(copia);
  localStorage.setItem('copiasRecogidas', JSON.stringify(copias));

  // Subir a Google Drive
  await subirCopiaADrive(copia);

  alert('Registro enviado y copia guardada localmente y en Google Drive.');
  e.target.reset();
  document.getElementById('numero_entrada').value = generarNumeroEntrada();
  if (marker) map.removeLayer(marker);
  document.getElementById('coordenadas_mapa').value = '';
});

/* ---------- INICIALIZACIÓN ---------- */
window.addEventListener('DOMContentLoaded', () => {
  cargarEspecies();
  cargarMunicipios();
  iniciarMapa();
  document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
  document.getElementById('numero_entrada').value = generarNumeroEntrada();
});
